{"version":3,"file":"index.js","names":["castSourceMap","sourceMap","version","toString","undefined","outputCssLoader","require","resolve","webpack4Loader","content","inputSourceMap","async","debug","resourcePath","preprocessor","extension","cacheProvider","rest","loaderUtils","getOptions","outputFileName","replace","asyncResolve","token","importer","context","path","isAbsolute","dirname","join","process","cwd","Promise","reject","err","result","addDependency","Error","transform","filename","pluginOptions","then","cssText","Buffer","from","cssSourceMapText","all","dependencies","map","dep","cacheInstance","getCacheInstance","set","setDependencies","getDependencies","request","encodeURIComponent","stringifiedRequest","stringifyRequest","callback","code"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport loaderUtils from 'loader-utils';\nimport type { RawSourceMap } from 'source-map';\n\nimport type { Result } from '@linaria/babel-preset';\nimport { transform } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport { getCacheInstance } from './cache';\n\ntype LoaderContext = Parameters<typeof loaderUtils.getOptions>[0];\n\nconst castSourceMap = <T extends { version: number } | { version: string }>(\n  sourceMap: T | null | undefined\n) =>\n  sourceMap\n    ? {\n        ...sourceMap,\n        version: sourceMap.version.toString(),\n      }\n    : undefined;\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\nexport default function webpack4Loader(\n  this: LoaderContext,\n  content: string,\n  inputSourceMap: RawSourceMap | null\n) {\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    ...rest\n  } = loaderUtils.getOptions(this) || {};\n\n  const outputFileName = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  const asyncResolve = (token: string, importer: string): Promise<string> => {\n    const context = path.isAbsolute(importer)\n      ? path.dirname(importer)\n      : path.join(process.cwd(), path.dirname(importer));\n    return new Promise((resolve, reject) => {\n      this.resolve(context, token, (err, result) => {\n        if (err) {\n          reject(err);\n        } else if (result) {\n          this.addDependency(result);\n          resolve(result);\n        } else {\n          reject(new Error(`Cannot resolve ${token}`));\n        }\n      });\n    });\n  };\n\n  transform(\n    content.toString(),\n    {\n      filename: this.resourcePath,\n      inputSourceMap: inputSourceMap ?? undefined,\n      pluginOptions: rest,\n      preprocessor,\n    },\n    asyncResolve\n  ).then(\n    async (result: Result) => {\n      if (result.cssText) {\n        let { cssText } = result;\n\n        if (sourceMap) {\n          cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n            result.cssSourceMapText || ''\n          ).toString('base64')}*/`;\n        }\n\n        await Promise.all(\n          result.dependencies?.map((dep) =>\n            asyncResolve(dep, this.resourcePath)\n          ) ?? []\n        );\n\n        try {\n          const cacheInstance = await getCacheInstance(cacheProvider);\n\n          await cacheInstance.set(this.resourcePath, cssText);\n\n          await cacheInstance.setDependencies?.(\n            this.resourcePath,\n            this.getDependencies()\n          );\n\n          const request = `${outputFileName}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n            cacheProvider ?? ''\n          )}!${this.resourcePath}`;\n          const stringifiedRequest = loaderUtils.stringifyRequest(\n            this,\n            request\n          );\n\n          this.callback(\n            null,\n            `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n            castSourceMap(result.sourceMap)\n          );\n        } catch (err) {\n          this.callback(err as Error);\n        }\n\n        return;\n      }\n\n      this.callback(null, result.code, castSourceMap(result.sourceMap));\n    },\n    (err: Error) => this.callback(err)\n  );\n}\n"],"mappings":"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"}