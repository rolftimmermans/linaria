{"version":3,"file":"index.js","names":["path","loaderUtils","transform","debug","getCacheInstance","castSourceMap","sourceMap","version","toString","undefined","outputCssLoader","require","resolve","webpack4Loader","content","inputSourceMap","async","resourcePath","preprocessor","extension","cacheProvider","rest","getOptions","outputFileName","replace","asyncResolve","token","importer","context","isAbsolute","dirname","join","process","cwd","Promise","reject","err","result","addDependency","Error","filename","pluginOptions","then","cssText","Buffer","from","cssSourceMapText","all","dependencies","map","dep","cacheInstance","set","setDependencies","getDependencies","request","encodeURIComponent","stringifiedRequest","stringifyRequest","callback","code"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport loaderUtils from 'loader-utils';\nimport type { RawSourceMap } from 'source-map';\n\nimport type { Result } from '@linaria/babel-preset';\nimport { transform } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport { getCacheInstance } from './cache';\n\ntype LoaderContext = Parameters<typeof loaderUtils.getOptions>[0];\n\nconst castSourceMap = <T extends { version: number } | { version: string }>(\n  sourceMap: T | null | undefined\n) =>\n  sourceMap\n    ? {\n        ...sourceMap,\n        version: sourceMap.version.toString(),\n      }\n    : undefined;\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\nexport default function webpack4Loader(\n  this: LoaderContext,\n  content: string,\n  inputSourceMap: RawSourceMap | null\n) {\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    ...rest\n  } = loaderUtils.getOptions(this) || {};\n\n  const outputFileName = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  const asyncResolve = (token: string, importer: string): Promise<string> => {\n    const context = path.isAbsolute(importer)\n      ? path.dirname(importer)\n      : path.join(process.cwd(), path.dirname(importer));\n    return new Promise((resolve, reject) => {\n      this.resolve(context, token, (err, result) => {\n        if (err) {\n          reject(err);\n        } else if (result) {\n          this.addDependency(result);\n          resolve(result);\n        } else {\n          reject(new Error(`Cannot resolve ${token}`));\n        }\n      });\n    });\n  };\n\n  transform(\n    content.toString(),\n    {\n      filename: this.resourcePath,\n      inputSourceMap: inputSourceMap ?? undefined,\n      pluginOptions: rest,\n      preprocessor,\n    },\n    asyncResolve\n  ).then(\n    async (result: Result) => {\n      if (result.cssText) {\n        let { cssText } = result;\n\n        if (sourceMap) {\n          cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n            result.cssSourceMapText || ''\n          ).toString('base64')}*/`;\n        }\n\n        await Promise.all(\n          result.dependencies?.map((dep) =>\n            asyncResolve(dep, this.resourcePath)\n          ) ?? []\n        );\n\n        try {\n          const cacheInstance = await getCacheInstance(cacheProvider);\n\n          await cacheInstance.set(this.resourcePath, cssText);\n\n          await cacheInstance.setDependencies?.(\n            this.resourcePath,\n            this.getDependencies()\n          );\n\n          const request = `${outputFileName}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n            cacheProvider ?? ''\n          )}!${this.resourcePath}`;\n          const stringifiedRequest = loaderUtils.stringifyRequest(\n            this,\n            request\n          );\n\n          this.callback(\n            null,\n            `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n            castSourceMap(result.sourceMap)\n          );\n        } catch (err) {\n          this.callback(err as Error);\n        }\n\n        return;\n      }\n\n      this.callback(null, result.code, castSourceMap(result.sourceMap));\n    },\n    (err: Error) => this.callback(err)\n  );\n}\n"],"mappings":"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"}