{"version":3,"file":"index.js","names":["path","transform","debug","getCacheInstance","outputCssLoader","require","resolve","webpack5Loader","webpack5LoaderPlugin","content","inputSourceMap","convertSourceMap","value","filename","undefined","file","mappings","names","sources","version","async","resourcePath","sourceMap","preprocessor","extension","cacheProvider","rest","getOptions","outputFileName","replace","asyncResolve","token","importer","context","isAbsolute","dirname","join","process","cwd","Promise","reject","err","result","addDependency","Error","toString","pluginOptions","then","cssText","Buffer","from","cssSourceMapText","all","dependencies","map","dep","cacheInstance","set","setDependencies","getDependencies","request","encodeURIComponent","stringifiedRequest","JSON","stringify","utils","contextify","rootContext","callback","code"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport type { RawSourceMap } from 'source-map';\nimport type { RawLoaderDefinitionFunction } from 'webpack';\n\nimport type { Result, Preprocessor } from '@linaria/babel-preset';\nimport { transform } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport type { ICache } from './cache';\nimport { getCacheInstance } from './cache';\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\ntype Loader = RawLoaderDefinitionFunction<{\n  sourceMap?: boolean;\n  preprocessor?: Preprocessor;\n  extension?: string;\n  cacheProvider?: string | ICache;\n}>;\n\nconst webpack5Loader: Loader = function webpack5LoaderPlugin(\n  content,\n  inputSourceMap\n) {\n  function convertSourceMap(\n    value: typeof inputSourceMap,\n    filename: string\n  ): RawSourceMap | undefined {\n    if (typeof value === 'string' || !value) {\n      return undefined;\n    }\n\n    return {\n      ...value,\n      file: value.file ?? filename,\n      mappings: value.mappings ?? '',\n      names: value.names ?? [],\n      sources: value.sources ?? [],\n      version: value.version ?? 3,\n    };\n  }\n\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    ...rest\n  } = this.getOptions() || {};\n\n  const outputFileName = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  const asyncResolve = (token: string, importer: string): Promise<string> => {\n    const context = path.isAbsolute(importer)\n      ? path.dirname(importer)\n      : path.join(process.cwd(), path.dirname(importer));\n    return new Promise((resolve, reject) => {\n      this.resolve(context, token, (err, result) => {\n        if (err) {\n          reject(err);\n        } else if (result) {\n          this.addDependency(result);\n          resolve(result);\n        } else {\n          reject(new Error(`Cannot resolve ${token}`));\n        }\n      });\n    });\n  };\n\n  transform(\n    content.toString(),\n    {\n      filename: this.resourcePath,\n      inputSourceMap: convertSourceMap(inputSourceMap, this.resourcePath),\n      pluginOptions: rest,\n      preprocessor,\n    },\n    asyncResolve\n  ).then(\n    async (result: Result) => {\n      if (result.cssText) {\n        let { cssText } = result;\n\n        if (sourceMap) {\n          cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n            result.cssSourceMapText || ''\n          ).toString('base64')}*/`;\n        }\n\n        await Promise.all(\n          result.dependencies?.map((dep) =>\n            asyncResolve(dep, this.resourcePath)\n          ) ?? []\n        );\n\n        try {\n          const cacheInstance = await getCacheInstance(cacheProvider);\n\n          await cacheInstance.set(this.resourcePath, cssText);\n\n          await cacheInstance.setDependencies?.(\n            this.resourcePath,\n            this.getDependencies()\n          );\n\n          const request = `${outputFileName}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n            typeof cacheProvider === 'string' ? cacheProvider : ''\n          )}!${this.resourcePath}`;\n          const stringifiedRequest = JSON.stringify(\n            this.utils.contextify(this.context || this.rootContext, request)\n          );\n\n          this.callback(\n            null,\n            `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n            result.sourceMap ?? undefined\n          );\n        } catch (err) {\n          this.callback(err as Error);\n        }\n\n        return;\n      }\n\n      this.callback(null, result.code, result.sourceMap ?? undefined);\n    },\n    (err: Error) => this.callback(err)\n  );\n};\n\nexport default webpack5Loader;\n"],"mappings":"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"}