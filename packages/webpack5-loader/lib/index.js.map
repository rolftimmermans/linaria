{"version":3,"file":"index.js","names":["outputCssLoader","require","resolve","webpack5Loader","webpack5LoaderPlugin","content","inputSourceMap","convertSourceMap","value","filename","undefined","file","mappings","names","sources","version","async","debug","resourcePath","sourceMap","preprocessor","extension","cacheProvider","rest","getOptions","outputFileName","replace","asyncResolve","token","importer","context","path","isAbsolute","dirname","join","process","cwd","Promise","reject","err","result","addDependency","Error","transform","toString","pluginOptions","then","cssText","Buffer","from","cssSourceMapText","all","dependencies","map","dep","cacheInstance","getCacheInstance","set","setDependencies","getDependencies","request","encodeURIComponent","stringifiedRequest","JSON","stringify","utils","contextify","rootContext","callback","code"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport type { RawSourceMap } from 'source-map';\nimport type { RawLoaderDefinitionFunction } from 'webpack';\n\nimport type { Result, Preprocessor } from '@linaria/babel-preset';\nimport { transform } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport type { ICache } from './cache';\nimport { getCacheInstance } from './cache';\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\ntype Loader = RawLoaderDefinitionFunction<{\n  sourceMap?: boolean;\n  preprocessor?: Preprocessor;\n  extension?: string;\n  cacheProvider?: string | ICache;\n}>;\n\nconst webpack5Loader: Loader = function webpack5LoaderPlugin(\n  content,\n  inputSourceMap\n) {\n  function convertSourceMap(\n    value: typeof inputSourceMap,\n    filename: string\n  ): RawSourceMap | undefined {\n    if (typeof value === 'string' || !value) {\n      return undefined;\n    }\n\n    return {\n      ...value,\n      file: value.file ?? filename,\n      mappings: value.mappings ?? '',\n      names: value.names ?? [],\n      sources: value.sources ?? [],\n      version: value.version ?? 3,\n    };\n  }\n\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    ...rest\n  } = this.getOptions() || {};\n\n  const outputFileName = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  const asyncResolve = (token: string, importer: string): Promise<string> => {\n    const context = path.isAbsolute(importer)\n      ? path.dirname(importer)\n      : path.join(process.cwd(), path.dirname(importer));\n    return new Promise((resolve, reject) => {\n      this.resolve(context, token, (err, result) => {\n        if (err) {\n          reject(err);\n        } else if (result) {\n          this.addDependency(result);\n          resolve(result);\n        } else {\n          reject(new Error(`Cannot resolve ${token}`));\n        }\n      });\n    });\n  };\n\n  transform(\n    content.toString(),\n    {\n      filename: this.resourcePath,\n      inputSourceMap: convertSourceMap(inputSourceMap, this.resourcePath),\n      pluginOptions: rest,\n      preprocessor,\n    },\n    asyncResolve\n  ).then(\n    async (result: Result) => {\n      if (result.cssText) {\n        let { cssText } = result;\n\n        if (sourceMap) {\n          cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n            result.cssSourceMapText || ''\n          ).toString('base64')}*/`;\n        }\n\n        await Promise.all(\n          result.dependencies?.map((dep) =>\n            asyncResolve(dep, this.resourcePath)\n          ) ?? []\n        );\n\n        try {\n          const cacheInstance = await getCacheInstance(cacheProvider);\n\n          await cacheInstance.set(this.resourcePath, cssText);\n\n          await cacheInstance.setDependencies?.(\n            this.resourcePath,\n            this.getDependencies()\n          );\n\n          const request = `${outputFileName}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n            typeof cacheProvider === 'string' ? cacheProvider : ''\n          )}!${this.resourcePath}`;\n          const stringifiedRequest = JSON.stringify(\n            this.utils.contextify(this.context || this.rootContext, request)\n          );\n\n          this.callback(\n            null,\n            `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n            result.sourceMap ?? undefined\n          );\n        } catch (err) {\n          this.callback(err as Error);\n        }\n\n        return;\n      }\n\n      this.callback(null, result.code, result.sourceMap ?? undefined);\n    },\n    (err: Error) => this.callback(err)\n  );\n};\n\nexport default webpack5Loader;\n"],"mappings":"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"}