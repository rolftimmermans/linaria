{"version":3,"file":"linaria.js","names":["modulesOptions","argv","yargs","usage","option","alias","type","description","requiresArg","demandOption","default","choices","coerce","s","toLowerCase","implies","parseSync","resolveRequireInsertionFilename","filename","replace","resolveOutputFilename","outDir","sourceRoot","outputFolder","path","relative","dirname","outputBasename","basename","extname","join","processFiles","files","options","startedAt","performance","now","count","resolvedFiles","reduce","acc","pattern","glob","sync","toString","absolute","ignore","cache","TransformCacheCollection","timings","Map","addTiming","key","value","set","Math","round","get","startTimes","onEvent","unknownEvent","ev","stage","split","startTime","stageStartTime","modifiedFiles","fs","lstatSync","isDirectory","outputFilename","code","cssText","sourceMap","cssSourceMapText","transform","readFileSync","pluginOptions","configFile","root","asyncResolveFallback","mkdirp","cssContent","sourceMaps","writeFileSync","insertCssRequires","inputFilename","resolve","relativePath","normalize","pathForImport","startsWith","statement","modules","normalizedInputFilename","inputContent","trim","endsWith","push","name","content","forEach","console","log","toFixed","has","delete","byFiles","Array","from","entries","sort","a","b","time","relativeFilename","process","cwd","_","config"],"sources":["../src/linaria.ts"],"sourcesContent":["/* eslint-disable no-console */\n/**\n * This file contains a CLI for Linaria.\n */\n\nimport fs from 'fs';\nimport path from 'path';\n\nimport glob from 'glob';\nimport mkdirp from 'mkdirp';\nimport normalize from 'normalize-path';\nimport yargs from 'yargs';\n\nimport { TransformCacheCollection, transform } from '@linaria/babel-preset';\nimport { asyncResolveFallback } from '@linaria/utils';\n\nconst modulesOptions = [\n  'commonjs',\n  'es2015',\n  'es6',\n  'esnext',\n  'native',\n] as const;\n\nconst argv = yargs\n  .usage('Usage: $0 [options] <files ...>')\n  .option('config', {\n    alias: 'c',\n    type: 'string',\n    description: 'Path to a config file',\n    requiresArg: true,\n  })\n  .option('out-dir', {\n    alias: 'o',\n    type: 'string',\n    description: 'Output directory for the extracted CSS files',\n    demandOption: true,\n    requiresArg: true,\n  })\n  .option('source-maps', {\n    alias: 's',\n    type: 'boolean',\n    description: 'Generate source maps for the CSS files',\n    default: false,\n  })\n  .option('source-root', {\n    alias: 'r',\n    type: 'string',\n    description: 'Directory containing the source JS files',\n    demandOption: true,\n    requiresArg: true,\n  })\n  .option('insert-css-requires', {\n    alias: 'i',\n    type: 'string',\n    description:\n      'Directory containing JS files to insert require statements for the CSS files',\n    requiresArg: true,\n  })\n  .option('transform', {\n    alias: 't',\n    type: 'boolean',\n    description: 'Replace template tags with evaluated values',\n  })\n  .option('modules', {\n    alias: 'm',\n    choices: modulesOptions,\n    description: 'Specifies a type of used imports',\n    default: 'commonjs' as const,\n    coerce: (s) => s.toLowerCase(),\n  })\n  .implies('insert-css-requires', 'source-root')\n  .implies('transform', 'insert-css-requires')\n  .option('ignore', {\n    alias: 'x',\n    type: 'string',\n    description: 'Pattern of files to ignore. Be sure to provide a string',\n    requiresArg: true,\n  })\n  .alias('help', 'h')\n  .alias('version', 'v')\n  .parseSync();\n\ntype Options = {\n  configFile?: string;\n  ignore?: string;\n  insertCssRequires?: string;\n  modules: typeof modulesOptions[number];\n  outDir: string;\n  sourceMaps?: boolean;\n  sourceRoot: string;\n  transform?: boolean;\n};\n\nfunction resolveRequireInsertionFilename(filename: string) {\n  return filename.replace(/\\.tsx?/, '.js');\n}\n\nfunction resolveOutputFilename(\n  filename: string,\n  outDir: string,\n  sourceRoot: string\n) {\n  const outputFolder = path.relative(sourceRoot, path.dirname(filename));\n  const outputBasename = path\n    .basename(filename)\n    .replace(path.extname(filename), '.css');\n\n  return path.join(outDir, outputFolder, outputBasename);\n}\n\nasync function processFiles(files: (number | string)[], options: Options) {\n  const startedAt = performance.now();\n  let count = 0;\n\n  const resolvedFiles = files.reduce(\n    (acc, pattern) => [\n      ...acc,\n      ...glob.sync(pattern.toString(), {\n        absolute: true,\n        ignore: options.ignore,\n      }),\n    ],\n    [] as string[]\n  );\n  const cache = new TransformCacheCollection();\n\n  const timings = new Map<string, number>();\n  const addTiming = (key: string, value: number) => {\n    timings.set(key, Math.round((timings.get(key) || 0) + value));\n  };\n\n  const startTimes = new Map<string, number>();\n  const onEvent = (unknownEvent: unknown) => {\n    const ev = unknownEvent as { type: string; filename: string };\n    const [, stage, type] = ev.type.split(':');\n    if (type === 'start') {\n      startTimes.set(ev.filename, performance.now());\n      startTimes.set(stage, performance.now());\n    } else {\n      const startTime = startTimes.get(ev.filename);\n      if (startTime) {\n        addTiming(ev.filename, performance.now() - startTime);\n      }\n      const stageStartTime = startTimes.get(stage);\n      if (stageStartTime) {\n        addTiming(stage, performance.now() - stageStartTime);\n      }\n    }\n  };\n\n  const modifiedFiles: { name: string; content: string }[] = [];\n\n  // eslint-disable-next-line no-restricted-syntax\n  for (const filename of resolvedFiles) {\n    if (fs.lstatSync(filename).isDirectory()) {\n      return;\n    }\n\n    const outputFilename = resolveOutputFilename(\n      filename,\n      options.outDir,\n      options.sourceRoot\n    );\n\n    // eslint-disable-next-line no-await-in-loop\n    const { code, cssText, sourceMap, cssSourceMapText } = await transform(\n      fs.readFileSync(filename).toString(),\n      {\n        filename,\n        outputFilename,\n        pluginOptions: {\n          configFile: options.configFile,\n        },\n        root: options.sourceRoot,\n      },\n      asyncResolveFallback,\n      {},\n      cache,\n      onEvent\n    );\n\n    if (cssText) {\n      mkdirp.sync(path.dirname(outputFilename));\n\n      const cssContent =\n        options.sourceMaps && sourceMap\n          ? `${cssText}\\n/*# sourceMappingURL=${outputFilename}.map */`\n          : cssText;\n\n      fs.writeFileSync(outputFilename, cssContent);\n\n      if (\n        options.sourceMaps &&\n        sourceMap &&\n        typeof cssSourceMapText !== 'undefined'\n      ) {\n        fs.writeFileSync(`${outputFilename}.map`, cssSourceMapText);\n      }\n\n      if (options.sourceRoot && options.insertCssRequires) {\n        const inputFilename = path.resolve(\n          options.insertCssRequires,\n          path.relative(options.sourceRoot, filename)\n        );\n\n        const relativePath = normalize(\n          path.relative(path.dirname(inputFilename), outputFilename)\n        );\n\n        const pathForImport = relativePath.startsWith('.')\n          ? relativePath\n          : `./${relativePath}`;\n\n        const statement =\n          options.modules === 'commonjs'\n            ? `\\nrequire('${pathForImport}');`\n            : `\\nimport \"${pathForImport}\";`;\n\n        const normalizedInputFilename =\n          resolveRequireInsertionFilename(inputFilename);\n\n        const inputContent = options.transform\n          ? code\n          : fs.readFileSync(normalizedInputFilename, 'utf-8');\n\n        if (!inputContent.trim().endsWith(statement)) {\n          modifiedFiles.push({\n            name: normalizedInputFilename,\n            content: `${inputContent}\\n${statement}\\n`,\n          });\n        }\n      }\n\n      count += 1;\n    }\n  }\n\n  modifiedFiles.forEach(({ name, content }) => {\n    fs.writeFileSync(name, content);\n  });\n\n  console.log(`Successfully extracted ${count} CSS files.`);\n\n  console.log(`\\nTimings:`);\n  console.log(`  Total: ${(performance.now() - startedAt).toFixed()}ms`);\n  console.log(`\\n  By stages:`);\n  let stage = 1;\n  while (timings.has(`stage-${stage}`)) {\n    console.log(`    Stage ${stage}: ${timings.get(`stage-${stage}`)}ms`);\n    timings.delete(`stage-${stage}`);\n    stage += 1;\n  }\n\n  console.log('\\n  By files:');\n\n  const byFiles = Array.from(timings.entries());\n  byFiles.sort(([, a], [, b]) => b - a);\n  byFiles.forEach(([filename, time]) => {\n    const relativeFilename = path.relative(\n      options.sourceRoot ?? process.cwd(),\n      filename\n    );\n    console.log(`    ${relativeFilename}: ${time}ms`);\n  });\n}\n\nprocessFiles(argv._, {\n  configFile: argv.config,\n  ignore: argv.ignore,\n  insertCssRequires: argv['insert-css-requires'],\n  modules: argv.modules,\n  outDir: argv['out-dir'],\n  sourceMaps: argv['source-maps'],\n  sourceRoot: argv['source-root'],\n  transform: argv.transform,\n});\n"],"mappings":"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"}